<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Use Case - Thực hiện Giao hàng</title>
    <style>
        body { font-family: 'Times New Roman', Times, serif; margin: 40px; }
        h1 { text-align: center; font-size: 20pt; }
        h2 { font-size: 14pt; margin-top: 20px; border-bottom: 1px solid #000; }
        h3 { font-size: 12pt; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        table, th, td { border: 1px solid #000; }
        th, td { padding: 8px; text-align: left; }
        ul, ol { margin-left: 20px; }
    </style>
</head>
<body>

<h1>Use Case - Thực hiện Giao hàng</h1>

<h2>1. Thông tin Use Case</h2>
<table>
    <tr><th style="width:30%">Tên Use Case</th><td>Thực hiện Giao hàng</td></tr>
    <tr><th>Actor</th><td>Nhân viên giao hàng (Shipper)</td></tr>
    <tr><th>Mô tả</th><td>Nhân viên giao hàng xem đơn được phân công, bắt đầu giao và hoàn thành giao hàng.</td></tr>
    <tr><th>Pre-conditions</th><td>- Đã đăng nhập với role <code>delivery_user</code><br/>- Đã được Admin phân công đơn hàng</td></tr>
    <tr><th>Post-conditions</th><td><b>Success:</b> Đơn hàng chuyển từ <code>assigned</code> → <code>shipping</code> → <code>delivered</code><br/><b>Fail:</b> Thông báo lỗi trạng thái không hợp lệ</td></tr>
</table>

<h2>2. Luồng sự kiện chính</h2>
<ol>
    <li>Shipper đăng nhập vào hệ thống</li>
    <li>Hệ thống hiển thị dashboard với thống kê đơn hàng</li>
    <li>Shipper xem danh sách đơn được phân công</li>
    <li>Shipper có thể thực hiện:
        <ul>
            <li>Extend Use Case: Bắt đầu giao hàng</li>
            <li>Extend Use Case: Hoàn thành giao hàng</li>
        </ul>
    </li>
</ol>

<h2>3. Luồng sự kiện phụ</h2>
<p>Nếu không có đơn hàng được phân công → Hệ thống hiển thị thông báo "Chưa có đơn hàng nào được phân công".</p>

<h2>4. Extend Use Case: Bắt đầu giao hàng</h2>
<h3>Luồng sự kiện chính</h3>
<ol>
    <li>Shipper chọn đơn ở trạng thái <code>assigned</code>, nhấn <b>Bắt đầu giao</b></li>
    <li>Hệ thống kiểm tra:
        <ul>
            <li><b>Rẽ nhánh 1:</b> Đơn không ở trạng thái <code>assigned</code>
                <ul>
                    <li>Thông báo: "Không thể bắt đầu giao (trạng thái không hợp lệ)"</li>
                </ul>
            </li>
            <li><b>Rẽ nhánh 2:</b> Đơn hợp lệ
                <ul>
                    <li>Cập nhật <code>status = shipping</code></li>
                    <li>Cập nhật <code>delivery_started_at = now()</code></li>
                    <li>Thông báo "Bắt đầu giao thành công"</li>
                    <li>Reload danh sách, hiển thị nút <b>Hoàn thành giao</b></li>
                </ul>
            </li>
        </ul>
    </li>
</ol>

<h2>5. Extend Use Case: Hoàn thành giao hàng</h2>
<h3>Luồng sự kiện chính</h3>
<ol>
    <li>Shipper chọn đơn ở trạng thái <code>shipping</code>, nhấn <b>Hoàn thành giao</b></li>
    <li>Hệ thống kiểm tra:
        <ul>
            <li><b>Rẽ nhánh 1:</b> Đơn không ở trạng thái <code>shipping</code>
                <ul>
                    <li>Thông báo: "Không thể hoàn thành (chưa bắt đầu giao)"</li>
                </ul>
            </li>
            <li><b>Rẽ nhánh 2:</b> Đơn hợp lệ
                <ul>
                    <li>Cập nhật <code>status = delivered</code></li>
                    <li>Cập nhật <code>delivery_completed_at = now()</code></li>
                    <li>Thông báo "Hoàn thành giao hàng thành công"</li>
                    <li>Reload danh sách, đơn chuyển sang tab "Đã giao"</li>
                </ul>
            </li>
        </ul>
    </li>
</ol>

<h3>Dữ liệu liên quan</h3>
<table>
    <tr><th>Bảng</th><th>Trường</th></tr>
    <tr><td>orders</td><td>id, delivery_user_id, status, delivery_started_at, delivery_completed_at</td></tr>
</table>

<h3>Quy tắc nghiệp vụ</h3>
<ul>
    <li>Shipper chỉ thấy đơn được phân công cho mình (<code>delivery_user_id = Auth::id()</code>)</li>
    <li>Bắt đầu giao: chỉ khi <code>status = assigned</code></li>
    <li>Hoàn thành giao: chỉ khi <code>status = shipping</code></li>
    <li>Không thể sửa hoặc hủy đơn sau khi bắt đầu giao</li>
</ul>

</body>
</html>
