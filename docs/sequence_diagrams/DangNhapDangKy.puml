@startuml Đăng nhập & Đăng ký
autonumber
actor "Khách hàng" as User
participant "View\n(Blade)" as View
participant "Controller\n(AuthController)" as Controller
database "Database" as DB

== Đăng ký tài khoản ==
User -> View: Truy cập trang đăng ký
activate View
View --> User: Hiển thị form đăng ký
deactivate View

User -> View: Nhập thông tin (name, email, password)
activate View
View -> Controller: POST /register
activate Controller

Controller -> DB: Kiểm tra email đã tồn tại
activate DB
DB --> Controller: Trả về kết quả
deactivate DB

alt Email chưa tồn tại
    Controller -> DB: Tạo user mới (is_active = 0)
    activate DB
    DB --> Controller: Trả về user_id
    deactivate DB
    
    Controller -> Controller: Tạo activation_token
    Controller -> Controller: Gửi email kích hoạt
    
    Controller --> View: Thông báo "Kiểm tra email để kích hoạt"
    deactivate Controller
    View --> User: Hiển thị thông báo
    deactivate View
else Email đã tồn tại
    Controller --> View: Thông báo "Email đã được đăng ký"
    deactivate Controller
    View --> User: Hiển thị lỗi
    deactivate View
end

== Kích hoạt tài khoản ==
User -> View: Nhấn link kích hoạt trong email
activate View
View -> Controller: GET /activate/{token}
activate Controller

Controller -> DB: Tìm user theo token
activate DB
DB --> Controller: Trả về user
deactivate DB

alt Token hợp lệ
    Controller -> DB: Cập nhật is_active = 1
    activate DB
    DB --> Controller: Xác nhận cập nhật
    deactivate DB
    
    Controller --> View: Chuyển hướng trang đăng nhập
    deactivate Controller
    View --> User: Hiển thị "Kích hoạt thành công"
    deactivate View
else Token không hợp lệ
    Controller --> View: Thông báo lỗi
    deactivate Controller
    View --> User: Hiển thị "Link không hợp lệ"
    deactivate View
end

== Đăng nhập ==
User -> View: Truy cập trang đăng nhập
activate View
View --> User: Hiển thị form đăng nhập
deactivate View

User -> View: Nhập email và password
activate View
View -> Controller: POST /login
activate Controller

Controller -> DB: Tìm user theo email
activate DB
DB --> Controller: Trả về user
deactivate DB

alt Thông tin đúng và đã kích hoạt
    Controller -> Controller: Kiểm tra password (Hash::check)
    Controller -> Controller: Tạo session (Auth::login)
    Controller -> DB: Merge giỏ hàng từ session vào DB
    activate DB
    DB --> Controller: Xác nhận
    deactivate DB
    
    Controller --> View: Chuyển hướng trang chủ
    deactivate Controller
    View --> User: Đăng nhập thành công
    deactivate View
else Sai thông tin
    Controller --> View: Thông báo "Thông tin không chính xác"
    deactivate Controller
    View --> User: Hiển thị lỗi
    deactivate View
else Chưa kích hoạt
    Controller --> View: Thông báo "Vui lòng kích hoạt tài khoản"
    deactivate Controller
    View --> User: Hiển thị lỗi
    deactivate View
end

@enduml
